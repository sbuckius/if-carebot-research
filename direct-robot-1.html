<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>p5.js Robot Image Picker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <!-- Load captions BEFORE the main script -->
  <script src="captions.js"></script>
  <style>
    :root { --w: 400px; --h: 600px; }
    html, body { height: 100%; margin: 0; background: #3b0a0a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { min-height: 100%; display: grid; place-items: center; padding: 12px; }
    .frame { width: var(--w); height: var(--h); position: relative; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.45); }

    /* Ensure the canvas sits under the overlay and hint on iOS */
    #defaultCanvas0 {
      display: block;
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    .overlay, .hint { z-index: 2; }

    .overlay { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:flex-end; padding:16px; gap:12px; pointer-events:auto; }
    .card { background: rgba(15,17,21,0.72); border: 1px solid rgba(255,255,255,0.08); color:#fff; border-radius:16px; padding:14px 16px; backdrop-filter: blur(10px); }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 6px; }
    .desc { font-size: 16px; color: #ff66cc; margin:0; line-height:1.55; max-height: 320px; overflow:auto; }
    .row { display:flex; justify-content:center; gap:20px; align-items:center; flex-wrap: wrap; }
    .btn { display:inline-block; text-decoration:none; background:#ffffff; color:#111827; font-weight:700; padding:10px 14px; border-radius:12px; font-size:14px; transition: background 0.2s, color 0.2s; }
    .btn:active { transform: translateY(1px); }
    #restart { background:#660033; color:#fff; font-size:18px; font-weight:800; border:2px solid #660033; padding:10px 18px; border-radius:14px; }
    #restart:hover { background:#cc0066; border-color:#cc0066; color:#fff; }
    .hint { position:absolute; top:10px; left:50%; transform:translateX(-50%); color:#fff; font-size:12px; opacity:.75; background:rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame" id="game-frame">
      <div class="hint" id="hint">Tap the image to select</div>
      <div class="overlay" id="overlay" style="display:none">
        <div class="card">
          <p class="title" id="resultTitle">You picked:</p>
          <p class="desc" id="resultText">â€”</p>
        </div>
        <div class="row">
          <a id="resultLink" class="btn" href="#" target="_blank" rel="noopener noreferrer">
            If you were paid, advance to the next level by clicking here!
          </a>
          <a id="restart" class="btn" href="#">Play Again</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ASSET_BASE = "./images";
    const CANVAS_W = 400, CANVAS_H = 600;
    const IMAGE_SIZE = 160;
    const SWITCH_MS = 250;
    const INSTRUCTION = "Select an image. Once you have selected your image, go tell the human robot to perform the action described below.";

    const CAPTIONS = (Array.isArray(window.captions) && window.captions.length >= 20)
      ? window.captions
      : Array.from({length:20}, (_,i)=>`Robot ${i}: placeholder text`);

    const items = Array.from({ length: 20 }, (_, i) => ({
      idx: i,
      text: CAPTIONS[i],
      link: `https://example.com/robot-${i}`,
      resolvedSrc: null
    }));

    let imgs = [];
    let currentIndex = 0;
    let lastSwitch = 0;
    let lockedIndex = -1;

    const overlay = document.getElementById('overlay');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');
    const resultLink = document.getElementById('resultLink');
    const restartBtn = document.getElementById('restart');
    const hintEl = document.getElementById('hint');

    // Defensive: make sure touches/clicks on the overlay don't bubble to the canvas
    overlay.addEventListener('click', e => e.stopPropagation(), { passive: true });
    overlay.addEventListener('touchstart', e => e.stopPropagation(), { passive: true });

    restartBtn.addEventListener('click', (e) => {
      e.preventDefault();
      lockedIndex = -1;
      overlay.style.display = 'none';
      hintEl.style.display = 'block';
      loop();
    });

    function preload() {
      const tryExts = [".jpg", ".jpeg", ".png", ".JPG", ".JPEG", ".PNG"];
      imgs = new Array(items.length);
      items.forEach((it, ix) => {
        const name = `robot${it.idx}`;
        const candidates = tryExts.map(ext => `${ASSET_BASE}/${name}${ext}`);
        const attempt = (k) => {
          if (k >= candidates.length) {
            const pg = createGraphics(IMAGE_SIZE, IMAGE_SIZE);
            pg.background(30);
            pg.fill(255);
            pg.textAlign(CENTER, CENTER);
            pg.textSize(12);
            pg.text(`Missing\n${name}.*`, IMAGE_SIZE/2, IMAGE_SIZE/2);
            imgs[ix] = pg;
            return;
          }
          const url = candidates[k];
          loadImage(url, (img) => {
            imgs[ix] = img;
            items[ix].resolvedSrc = url;
          }, () => attempt(k + 1));
        };
        attempt(0);
      });
    }

    function setup() {
      const c = createCanvas(CANVAS_W, CANVAS_H);
      c.parent('game-frame');
      imageMode(CENTER);
      noStroke();
      lastSwitch = millis();
    }

    function getLayout() {
      const boxX = width / 2;
      const boxY = 120;
      const boxW = width - 30;
      const boxH = 240;
      const boxLeft  = boxX - boxW / 2;
      const boxRight = boxX + boxW / 2;

      const leftColW = IMAGE_SIZE + 130;
      const imgX = boxLeft + leftColW / 2;
      const imgY = boxY;

      const textPad = 20;
      const textX = boxLeft + leftColW + textPad;
      const textY = imgY - IMAGE_SIZE / 2 + 4;
      const textW = Math.max(140, boxRight - textX - textPad);

      return { boxX, boxY, boxW, boxH, imgX, imgY, textX, textY, textW };
    }

    function draw() {
      background('#3b0a0a');

      if (lockedIndex === -1 && millis() - lastSwitch > SWITCH_MS) {
        currentIndex = (currentIndex + 1) % items.length;
        lastSwitch = millis();
      }

      const L = getLayout();
      const img = imgs[currentIndex];

      push();
      fill('#cc338b');
      rectMode(CENTER);
      rect(L.boxX, L.boxY, L.boxW, L.boxH, 20);

      if (img && img.width > 0) image(img, L.imgX, L.imgY, IMAGE_SIZE, IMAGE_SIZE);
      else {
        fill(255, 255, 255, 28);
        rectMode(CENTER);
        rect(L.imgX, L.imgY, IMAGE_SIZE, IMAGE_SIZE, 18);
        fill(255); textAlign(CENTER, CENTER); textSize(14);
        text('Loading...', L.imgX, L.imgY);
      }

      fill('#fff');
      textSize(15);
      textWrap(WORD);
      textAlign(LEFT, TOP);
      text(INSTRUCTION, L.textX, L.textY, L.textW);
      pop();

      if (lockedIndex !== -1) noLoop();
    }

    function mousePressed() {
      if (lockedIndex !== -1) return;
      const L = getLayout();
      const half = IMAGE_SIZE / 2;
      if (mouseX >= L.imgX - half && mouseX <= L.imgX + half && mouseY >= L.imgY - half && mouseY <= L.imgY + half) {
        lockedIndex = currentIndex;
        showResult(lockedIndex);
      }
    }

    // iPhone fix: only handle touches that actually happen on the canvas;
    // DO NOT return false (which would block default behavior like links).
    function touchStarted(e) {
      const cnv = document.getElementById('defaultCanvas0');
      if (!cnv) return; // allow default
      const rect = cnv.getBoundingClientRect();
      const t = (e.touches && e.touches[0]) || (e.changedTouches && e.changedTouches[0]);
      if (!t) return; // allow default
      const x = t.clientX, y = t.clientY;
      const insideCanvas = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
      if (!insideCanvas) return; // allow default for links/buttons
      mousePressed(); // treat touch as click inside the sketch
      // no return value
    }

    function showResult(idx) {
      const { text, link } = items[idx];
      resultTitle.textContent = `You picked robot #${idx}`;
      resultText.textContent = text;
      resultLink.href = link;
      overlay.style.display = 'flex';
      hintEl.style.display = 'none';
      loop();
    }

    // expose to p5
    window.preload = preload;
    window.setup = setup;
    window.draw = draw;
    window.mousePressed = mousePressed;
    window.touchStarted = touchStarted;
  </script>
</body>
</html>
