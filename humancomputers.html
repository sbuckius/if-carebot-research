<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Tech Work — Centered App</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.2/lib/p5.min.js"></script>
<style>
  :root{
    --rose:#ff5c8a; --hot:#ff335c; --candy:#ff7aa8; --bubble:#ffd2e6;
    --berry:#8e004b; --crimson:#a1002b; --maroon:#5b001f; --wine:#6d0033;
    --plum:#4c0038; --violet:#4c0044; --ink:#fff2f6;
    --shadow:0 8px 28px rgba(255,64,128,.28); --border:var(--candy);
  }

  /* allow page scrolling on iPhone */
  html,body{
    margin:0;
    min-height:100%;
    color:var(--ink);
    -webkit-overflow-scrolling: touch;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Helvetica Neue",sans-serif;
    background:
      radial-gradient(1200px 1000px at -10% 0%, var(--rose) 0%, transparent 55%),
      radial-gradient(1200px 900px at 110% 10%, var(--hot) 0%, transparent 55%),
      radial-gradient(800px 800px at 50% 110%, var(--berry) 0%, transparent 60%),
      linear-gradient(165deg, var(--maroon), var(--wine) 45%, var(--violet));
  }

  /* safe-area padding, centered column */
  .wrap{
    max-width:980px;
    margin:clamp(16px,4vmin,32px) auto;
    padding:
      max(0px, env(safe-area-inset-top))
      clamp(12px,3vmin,24px)
      calc(56px + env(safe-area-inset-bottom))
      clamp(12px,3vmin,24px);
  }

  .app{
    border:1px solid var(--border);
    background:color-mix(in oklab, rgba(255,255,255,.04) 20%, var(--maroon) 80%);
    box-shadow:var(--shadow);border-radius:18px;
  }

  .app-header,.app-footer{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:12px 14px;background:linear-gradient(180deg, rgba(25,8,18,.8), rgba(25,8,18,.35));
  }

  .title{
    font-weight:800;letter-spacing:.2px;line-height:1.25;
    font-size:clamp(14px,2.4vw,18px);
    background:linear-gradient(90deg, var(--hot), var(--rose) 40%, var(--candy));
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }
  .progress{font-size:clamp(12px,2vw,14px);opacity:.9;}

  /* iPhone-safe, shrink-to-fit canvas height; draw area only suppresses scroll */
  .canvas-shell{
    position:relative;width:100%;
    height: clamp(260px, 60svh, 520px);
    background:#160012;
    touch-action: none;
  }
  canvas{display:block;width:100%;height:100%;}

  /* spacer so there’s always a spot to start scrolling */
  .scroll-spacer{ height: 32px; }

  .app-footer{display:grid;grid-template-columns:1fr auto;gap:10px;}
  .hints{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .pill{
    background:color-mix(in oklab, var(--plum) 70%, #000 30%);
    color:var(--bubble);padding:8px 10px;border-radius:999px;
    border:1px solid var(--border);font-size:clamp(12px,2vw,14px);
  }
  .actions{display:flex;gap:8px;flex-wrap:wrap;}

  .btn{
    appearance:none;border:1px solid var(--border);color:#fff;
    background:linear-gradient(180deg, var(--hot), var(--crimson));
    padding:12px 16px;border-radius:14px;font-weight:700;font-size:16px;
    min-height:44px;cursor:pointer;box-shadow:var(--shadow);
    -webkit-tap-highlight-color:transparent;text-decoration:none;
    display:inline-flex;align-items:center;gap:10px;
  }
  .btn.secondary{background:linear-gradient(180deg, var(--rose), var(--berry));}
  .btn[disabled]{opacity:.6;cursor:not-allowed;filter:saturate(.7);}
  .final-link-btn{display:inline-block;}

  .pop-msg{
    position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
    background:#2a001d;color:var(--bubble);border:1px solid var(--border);
    padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);
    font-size:14px;display:none;z-index:9999;
  }
  .pop-msg.show{display:block;}

  .overlay{
    position:fixed;inset:0;
    background:
      radial-gradient(900px 900px at 50% -10%, rgba(255,77,141,.25), transparent 60%),
      rgba(18,0,22,.85);
    display:none;z-index:9999;backdrop-filter:blur(2px);
  }
  .overlay.open{display:grid;place-items:center;}
  .overlay-card{
    width:min(100vw - 40px,1000px);
    height:min(100vh - 40px,720px);
    background:#1b0018;border:1px solid var(--candy);border-radius:18px;overflow:hidden;
    box-shadow:0 12px 50px rgba(0,0,0,.45),0 4px 20px rgba(255,77,141,.25) inset;
    display:grid;grid-template-rows:auto 1fr auto;
  }
  .overlay-header{
    display:flex;align-items:center;justify-content:space-between;gap:8px;
    padding:10px 14px;background:linear-gradient(180deg, var(--crimson), var(--berry));
    color:var(--bubble);font-weight:700;
  }
  .countdown{font-variant-numeric:tabular-nums;background:#25001a;padding:6px 10px;border-radius:10px;border:1px solid var(--rose);}
  .overlay iframe{width:100%;height:100%;border:0;background:#0f0011;}
  .overlay-footer{padding:10px 14px;background:#230018;display:flex;justify-content:flex-end;gap:10px;}
  .overlay a.inline-btn{
    color:#fff;text-decoration:none;font-weight:700;
    background:linear-gradient(180deg, var(--rose), var(--plum));
    padding:10px 14px;border-radius:10px;border:1px solid var(--candy);
  }
</style>
</head>
<body>
  <main class="wrap">
    <section class="app" aria-label="Tech Work Task">
      <header class="app-header">
        <div class="title">Draw a box around every person doing work with technology</div>
        <div class="progress" id="progress"></div>
      </header>

      <div class="canvas-shell">
        <div id="canvasHolder" style="position:absolute;inset:0;"></div>
      </div>
      <div class="scroll-spacer" aria-hidden="true"></div>

      <footer class="app-footer">
        <div class="hints">
          <div class="pill">Drag to draw rectangles</div>
          <div class="pill">Undo: <b>Z</b></div>
          <div class="pill">Next: <b>N</b></div>
        </div>
        <div class="actions">
          <button id="openCalcBtn" class="btn secondary" type="button">Human Computers</button>
          <button id="undo" class="btn" type="button">Undo</button>
          <button id="next" class="btn" type="button" disabled>Next</button>
        </div>
      </footer>
    </section>

    <!-- completion button appears here (outside .app so the page can scroll to it) -->
    <div id="completionSlot"></div>
  </main>

  <div id="popupMsg" class="pop-msg">Couldn’t open a temporary tab. Please allow pop-ups for this site.</div>

  <!-- overlay fallback for redirect -->
  <div id="calcOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
    <div class="overlay-card">
      <header class="overlay-header">
        <div id="calcTitle">Opening: Computer History Museum — Calculators</div>
        <small>Auto-closing in <span class="countdown" id="countdown">3</span>s…</small>
      </header>
      <iframe id="calcFrame" title="CHM page"></iframe>
      <div class="overlay-footer">
        <a id="calcDirectLink" class="inline-btn" href="#" target="_blank" rel="noopener">Open in a new tab</a>
        <a id="closeOverlayBtn" class="inline-btn" href="#" role="button">Close</a>
      </div>
    </div>
  </div>

<script>
/* ========= Settings ========= */
const FOLDER_PATH="images/";
const FILE_PREFIX="techwork";
const FILE_EXT=".png";
const MAX_ATTEMPTS=500;

const EXTERNAL_URL="https://www.computerhistory.org/revolution/calculators/1/65";
const DISPLAY_SECONDS=3;

/* ========= State ========= */
let imgs=[],imgMeta=[],current=0,dragging=false,dragStart=null,tempRect=null,scaleInfo=null,finished=false,canvas;
let discovering=true;

/* ========= Auto-discover images ========= */
function loadImageAsync(p){return new Promise((res,rej)=>{const im=loadImage(p,()=>res(im),()=>rej(new Error("load-failed")));});}
async function discoverImages(){let i=0;try{for(;i<MAX_ATTEMPTS;i++){const img=await loadImageAsync(`${FOLDER_PATH}${FILE_PREFIX}${i}${FILE_EXT}`);imgs.push(img);imgMeta.push({boxes:[]});}}catch(e){}finally{discovering=false;}}

/* ========= p5 ========= */
function setup(){
  const holder=document.getElementById('canvasHolder');
  pixelDensity(window.devicePixelRatio||1);
  canvas=createCanvas(holder.clientWidth, holder.clientHeight);
  canvas.parent('canvasHolder');
  canvas.elt.oncontextmenu=e=>e.preventDefault();
  colorMode(HSB,360,100,100,1);

  // Resize with URL bar/orientation changes
  new ResizeObserver(()=>{resizeCanvas(holder.clientWidth,holder.clientHeight);updateScaleInfo();}).observe(holder);

  // UI
  document.getElementById('undo').onclick=undoLast;
  document.getElementById('next').onclick=nextImage;
  document.getElementById('openCalcBtn').addEventListener('click',openInNewTabThenReturn);

  // Load images
  (async()=>{await discoverImages(); updateScaleInfo();})();
}

function draw(){
  // pulsing gradient (maroon → pinks)
  const t=millis()*0.001, base=335+15*sin(t*0.4);
  const cTop=color(base,70,25), cMid=color((base+10)%360,80,40), cBot=color((base+20)%360,90,55);
  drawGrad(cTop,cMid,cBot);

  if(discovering) return drawMsg("Looking for images…");
  if(imgs.length===0) return drawMsg("No images found in images/");
  if(finished) return drawCompletion();

  const img=imgs[current]; if(!img) return drawMsg("Loading…");
  updateScaleInfo(); image(img,scaleInfo.x,scaleInfo.y,scaleInfo.w,scaleInfo.h);

  // saved boxes
  push(); noFill(); strokeWeight(Math.max(1,2*(width/1024)));
  for(const r of imgMeta[current].boxes){
    const {x,y,w,h}=imgRectToCanvas(r);
    stroke(330,60,95,.85); rect(x,y,w,h);
    stroke(330,15,100,1);  rect(x,y,w,h);
  } pop();

  // live drag
  if(dragging && tempRect){
    push(); noFill(); stroke(330,15,100,1); strokeWeight(3);
    rect(tempRect.x,tempRect.y,tempRect.w,tempRect.h); pop();
  }

  document.getElementById('progress').textContent=`Image ${current+1} of ${imgs.length}`;
}

/* ========= helpers ========= */
function drawGrad(a,b,c){
  const ctx=drawingContext, g=ctx.createLinearGradient(0,0,0,height);
  g.addColorStop(0, toRGBA(a)); g.addColorStop(.5, toRGBA(b)); g.addColorStop(1, toRGBA(c));
  ctx.save(); ctx.fillStyle=g; ctx.fillRect(0,0,width,height); ctx.restore();
}
function toRGBA(col){return `rgba(${red(col)|0},${green(col)|0},${blue(col)|0},${alpha(col)/255})`;}
function drawMsg(m){ push(); fill(0,0,100); noStroke(); textAlign(CENTER,CENTER); textSize(16); text(m, width/2, height/2); pop(); }

/* ========= completion ========= */
function drawCompletion(){
  push(); noStroke(); fill(330,20,100); textAlign(CENTER,CENTER); textSize(20);
  text("you have completed this HIT.", width/2, height/2 - 18);
  textSize(16); text("Get your next task here:", width/2, height/2 + 8); pop();

  if(!document.getElementById('final-link')){
    const d=document.createElement('div');
    d.id='final-link';
    d.style.display='grid'; d.style.placeItems='center'; d.style.marginTop='24px';
    d.innerHTML=`<a class="final-link-btn btn secondary" href="https://sbuckius.github.io/if-carebot-research/hit.html" target="_blank" rel="noopener">
      You completed this HIT! Go to your next task</a>`;
    document.getElementById('completionSlot').appendChild(d);
  }
}

/* ========= interaction (prevent default only while dragging) ========= */
function mousePressed(){
  if(finished) return;
  if(!inside(mouseX,mouseY)) return;
  dragging=true;
  dragStart={x:mouseX,y:mouseY};
  tempRect={x:mouseX,y:mouseY,w:0,h:0};
  return false;
}
function mouseDragged(){
  if(!dragging) return;
  tempRect.w=mouseX-dragStart.x;
  tempRect.h=mouseY-dragStart.y;
  return false;
}
function mouseReleased(){
  if(!dragging) return;
  dragging=false;
  const n=normalizeRect(tempRect); tempRect=null;
  const clamped=clampRectToImage(n);
  const MIN=10; if(clamped.w<MIN||clamped.h<MIN) return;
  imgMeta[current].boxes.push(canvasRectToImg(clamped));
  updateUI();
  return false;
}
function touchStarted(){ return mousePressed(); }
function touchMoved(){ return mouseDragged(); }
function touchEnded(){ return mouseReleased(); }

function keyPressed(){ if(key==='z'||key==='Z') undoLast(); if(key==='n'||key==='N') nextImage(); }
function undoLast(){ if(finished) return; const b=imgMeta[current].boxes; if(b.length>0){ b.pop(); updateUI(); } }
function nextImage(){
  if(finished) return;
  if(imgMeta[current].boxes.length===0) return;
  if(current<imgs.length-1){
    current++; updateScaleInfo(); updateUI();
  } else {
    finished=true;
    document.getElementById('undo').disabled=true;
    document.getElementById('next').disabled=true;
  }
}
function updateUI(){
  const n=document.getElementById('next'), u=document.getElementById('undo');
  if(finished){ n.disabled=true; u.disabled=true; }
  else { const has=imgMeta[current].boxes.length>0; n.disabled=!has; u.disabled=!has; }
}

/* ========= geometry ========= */
function updateScaleInfo(){
  const img=imgs[current]; if(!img) return;
  const cw=width, ch=height, iw=img.width, ih=img.height;
  const s=Math.min(cw/iw, ch/ih);
  scaleInfo={ x:(cw - iw*s)/2, y:(ch - ih*s)/2, w:iw*s, h:ih*s, scale:s };
}
function inside(x,y){
  return scaleInfo && x>=scaleInfo.x && x<=scaleInfo.x+scaleInfo.w &&
         y>=scaleInfo.y && y<=scaleInfo.y+scaleInfo.h;
}
function normalizeRect(r){
  const x=r.w<0? r.x+r.w : r.x;
  const y=r.h<0? r.y+r.h : r.y;
  return { x, y, w:Math.abs(r.w), h:Math.abs(r.h) };
}
function canvasToImgPoint(px,py){ return { x:(px-scaleInfo.x)/scaleInfo.scale, y:(py-scaleInfo.y)/scaleInfo.scale }; }
function canvasRectToImg(r){
  const p1=canvasToImgPoint(r.x, r.y);
  const p2=canvasToImgPoint(r.x+r.w, r.y+r.h);
  return { x:Math.min(p1.x,p2.x), y:Math.min(p1.y,p2.y), w:Math.abs(p2.x-p1.x), h:Math.abs(p2.y-p1.y) };
}
function clampRectToImage(r){
  if(!scaleInfo) return r;
  const ix=scaleInfo.x, iy=scaleInfo.y, iw=scaleInfo.w, ih=scaleInfo.h;
  const x1=Math.max(ix, Math.min(ix+iw, r.x));
  const y1=Math.max(iy, Math.min(iy+ih, r.y));
  const x2=Math.max(ix, Math.min(ix+iw, r.x+r.w));
  const y2=Math.max(iy, Math.min(iy+ih, r.y+r.h));
  return { x:Math.min(x1,x2), y:Math.min(y1,y2), w:Math.abs(x2-x1), h:Math.abs(y2-y1) };
}
function imgRectToCanvas(r){
  return { x:scaleInfo.x+r.x*scaleInfo.scale, y:scaleInfo.y+r.y*scaleInfo.scale, w:r.w*scaleInfo.scale, h:r.h*scaleInfo.scale };
}

/* ========= Redirect (new tab + 3s + close; overlay fallback) ========= */
const openBtn=document.getElementById('openCalcBtn'),
      overlay=document.getElementById('calcOverlay'),
      iframe=document.getElementById('calcFrame'),
      countdown=document.getElementById('countdown'),
      directLink=document.getElementById('calcDirectLink'),
      closeBtn=document.getElementById('closeOverlayBtn'),
      popup=document.getElementById('popupMsg');
let timer=null,tick=null,remain=DISPLAY_SECONDS;

function reset(){clearTimeout(timer);clearInterval(tick);remain=DISPLAY_SECONDS;if(countdown) countdown.textContent=remain;}
function closeO(){overlay.classList.remove('open');iframe.src="about:blank";reset();openBtn.disabled=false;document.title="Tech Work — Centered App";}
function overlayFallback(){
  openBtn.disabled=true;overlay.classList.add('open');iframe.src=EXTERNAL_URL;directLink.href=EXTERNAL_URL;
  reset();tick=setInterval(()=>{remain--;if(countdown) countdown.textContent=Math.max(remain,0);if(remain<=0)clearInterval(tick);},1000);
  timer=setTimeout(closeO,DISPLAY_SECONDS*1000);
}
function openInNewTabThenReturn(){
  const newWin=window.open(EXTERNAL_URL,'_blank');
  if(newWin&&!newWin.closed){
    openBtn.disabled=true;reset();
    tick=setInterval(()=>{remain--;if(remain<=0)clearInterval(tick);
      document.title=`(${Math.max(remain,0)}s) Tech Work — Centered App`;},1000);
    timer=setTimeout(()=>{try{newWin.close();}catch(e){}document.title="Tech Work — Centered App";openBtn.disabled=false;reset();},DISPLAY_SECONDS*1000);
  } else {
    popup.classList.add('show'); setTimeout(()=>popup.classList.remove('show'),3000);
    overlayFallback();
  }
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&overlay.classList.contains('open'))closeO();});
overlay.addEventListener('click',e=>{if(e.target===overlay)closeO();});
closeBtn.addEventListener('click',e=>{e.preventDefault();closeO();});
</script>
</body>
</html>
